$schema: "http://json-schema.org/draft-07/schema#"

$id: "specimen"
title: Specimen
type: object

propertyNames:  # this will reject any unknown properties, note that 'additionalProperties: false' does not work with allOf
  anyOf:
  - pattern: '^id$'
  - pattern: '^donor_id$'
  - pattern: '^type$'
  - pattern: '^program$'
  - pattern: '^submitter_id$'
  - pattern: '^donor_submitter_id$'
  - pattern: '^normal_or_tumour_designation$'
  - pattern: '^specimen_type$'
  - pattern: '^tumour_histology_type$'
  - pattern: '^tumour_histological_type_other$'
  - pattern: '^specimen_anatomic_site$'
  - pattern: '^tumour_stage_at_specimen_acquisition$'
  - pattern: '^specimen_acquisition_interval$'
  - pattern: '^specimen_processing$'
  - pattern: '^specimen_storage$'
  - pattern: '^central_pathology_confirmed$'
  - pattern: '^tumour_grading_system$'
  - pattern: '^tumour_grade$'
  - pattern: '^percent_tumour_cells$'
  - pattern: '^percent_proliferating_cells$'
  - pattern: '^percent_inflammatory_tissue$'
  - pattern: '^percent_stromal_cells$'
  - pattern: '^percent_necrosis$'

definitions:
  relationDef:
    $ref: '_definitions#/relationDef'
    const:
      category: bioentity
      version: 0
      primaryKey:
      - '#/definitions/systemProperties/properties/id'
      naturalKey:
      - '#/properties/program'
      - '#/properties/submitter_id'
      references:
      - foreignKey:
        - '#/properties/program'
        - '#/properties/donor_submitter_id'
        targetEntity: 'donor'
        targetKey:  # relationship by naturalKey
        - 'donor#/properties/program'
        - 'donor#/properties/submitter_id'
      - foreignKey:
        - '#/definitions/systemProperties/properties/donor_id'
        targetEntity: 'donor'
        targetKey:  # relationship by primaryKey
        - 'donor#/definitions/systemProperties/properties/id'
  scriptValidations:  # script based validation, call returns True for valid or False for invalid
    $ref: '_definitions#/scriptValidations'
    const:
    - "$sumNoGreaterThan(1, [percent_tumour_cells, percent_proliferating_cells, percent_inflammatory_tissue, percent_stromal_cells, percent_necrosis])"
  systemProperties:  # properties will be populated by the system
    properties:
      id:  # primary key, defined in 'primaryKey'
        allOf:
        - $ref: _definitions#/common/properties/id
        - pattern: "^SP"  # id must start with "SP", in addition to pattern defined at _definitions#/common/properties/id
      donor_id:  # foreign key to donor entity, the relationship is defined in 'references'
        $ref: donor#/definitions/systemProperties/properties/id

required:
- type
- submitter_id
- donor_submitter_id
- program
- normal_or_tumour_designation
- specimen_type

properties:
  type:
    const: "specimen"
  program:
    $ref: _definitions#/common/properties/program_short_name
  submitter_id:
    $ref: _definitions#/common/properties/submitter_id
    description: "Submitter's specimen ID"
  donor_submitter_id:
    $ref: _definitions#/common/properties/submitter_id
  normal_or_tumour_designation:
    type: string
    scriptValidations:
    - "$cv(tumour_or_normal_designation, specimen_type)"
  specimen_type:
    type: string
    scriptValidations:
    - "$cv(specimen_type)"
  tumour_histology_type:
    type: string
    scriptValidations:
    - "$cv(tumour_histology_type_icd_o_3_code)"
  tumour_histological_type_other:
    type: string
  specimen_anatomic_site:  # from: specimen_anatomic_collection
    type: string
    scriptValidations:
    - "$cv(anatomic_site)"
  tumour_stage_at_specimen_acquisition:
    type: string
    scriptValidations:
    - "$cv(tumour_stage)"
  specimen_acquisition_interval:
    type: integer
    minimum: 0
  specimen_processing:
    type: string
    scriptValidations:
    - "$cv(specimen_processing)"
  specimen_storage:
    enum:
    - frozen, liquid nitrogen
    - frozen, -70 freezer
    - frozen, vapor phase
    - RNA later frozen
    - paraffin block
    - cut slide
    - other
    - not applicable
  central_pathology_confirmed:
    type: string
    scriptValidations:
    - "$cv(yes_no_unknown)"
  tumour_grading_system:
    enum: [ "default" ]
  tumour_grade:
    enum: [ Gx, G1, G2, G3, G4 ]
  percent_tumour_cells:
    type: number
    minimum: 0
    maximum: 1
  percent_proliferating_cells:
    type: number
    minimum: 0
    maximum: 1
  percent_inflammatory_tissue:
    type: number
    minimum: 0
    maximum: 1
  percent_stromal_cells:
    type: number
    minimum: 0
    maximum: 1
  percent_necrosis:
    type: number
    minimum: 0
    maximum: 1
