$schema: "http://dcc.icgc-argo.org/draft-00/schema#"

$id: "lane_bam_qc"
title: Unaligned lane level sequencing reads QC report
version: 0
category: data_bundle
type: object
description: ""
additionalProperties: false

systemProperties:
  properties:
    status:
      $ref: _definitions#/common/properties/bundle_status
    id:
      $ref: _definitions#/common/properties/uuid
    read_group_id:  # FK points to PK of read_group
      $ref: lane_bam_submission#/systemProperties/properties/id
    sample_id:  # to be magically populated by the system through traversing back to the 'sample'
      $ref: lane_bam_submission#/systemProperties/properties/id

required:
- type
- program
- lane_bam_submission_id
- analysis
- qc_metrics
- input_files
- files

primaryKey:
  surrogateKey: [ id ]

uniqueKeys:
- [ lane_bam_submission_id ]  # one lane bam can have only one lane_bam_qc record

references:
- selfKey: [ lane_bam_submission_id ]
  reference:
    targetEntity: lane_bam_submission  # lane_bam_qc to lane_bam_submission relationship is one-to-one
    targetKey: [ id ]

properties:
  type:
    const: "lane_bam_qc"
  program:
    $ref: _definitions#/common/properties/program_short_name
  lane_bam_submission_id:  # one lane_bam_submission per lane_bam_qc
    type: string
  analysis:
    type: object
    properties:
      analysis_type:
        const: 'QC'
      core_tool:
        const: 'Picard'
      tool:  # Tool refers to what's in GA4GH's Tool Registry Service
        type: object
        properties:
          registry:
            type: string  # such as Dockstore
          tool_id:
            type: string
          tool_name:
            type: string
          version:
            type: string
      execution:
        type: object
        properties:
          runner_name:
            type: string
          runner_version:
            type: string
          job_id:
            type: string
          started_at:
            type: string
            format: date-time
          completed_at:
            type: string
            format: date-time
  qc_metrics:
    type: object
    properties:
      pf_bases:
        description: "pass filter bases"
        type: integer
      pf_reads:
        description: "pass filter reads"
        type: integer
      total_bases:
        description: "total bases"
        type: integer
      total_reads:
        description: "total reads"
        type: integer
  input_files:  # input file for this QC tool could be locally prepared from preprocessing steps
    type: object
    properties:
      lane_bam:
        type: object
        references:
        - selfKey: [ bundle_id, object_id ]
          reference:
            targetEntity: data_object
            targetKey: [ bundle_id, id ]
        properties:
          object_uri:  # if file is local, object_id will be 'null'
            type: string  # pattern: song://<repository>/<bundle_id>/<object_id>
          bundle_id:  # lane_bam_submission
            type: string
          object_id:  # lane_bam object ID in the above lane_bam_submission
            type: string
          name:  # file name
            type: string
          repository:  # repo where the object resides
            type: string
  files:
    properties:
      metrics_file:
        $id: "#data_object/metrics_file"
        type: object
        primaryKey:
          surrogateKey: [ id ]
        $ref: _definitions#/submitted_file

        systemProperties:
          required: [ id, program, repository, derived_from, bundle_id, bundle_type, format, data_type ]
          allOf:
          - $ref: _definitions#/data_object
          - $ref: _definitions#/repositoryProperties
          - properties:
              id:  # surrogate key
                $ref: _definitions#/data_object/properties/id
              program:  # copied from containing parent
                $ref: "#/properties/program"
              derived_from:
                type: object
                properties:
                  type:
                    const: "read_group"
                  id:  # copied from containing parent
                    $ref: "#/systemProperties/properties/read_group_id"
              bundle_id:  # copied from containing parent
                $ref: "#/systemProperties/properties/id"
              bundle_type:
                const: "lane_bam_qc"
              format:
                const: "TXT"
                default: "TXT"
              date_type:
                const: "Read Group QC Metrics"
                default: "Read Group QC Metrics"
