$schema: "http://json-schema.org/draft-07/schema#"

$id: "dna_alignment_qc"
title: QC metrics of aligned DNA sequencing reads
type: object
description: ""
additionalProperties: false

definitions:
  version:
    $ref: '_definitions#/_/properties/version'
    const: 0
  relationDef:
    $ref: '_definitions#/_/properties/relationDef'
    const:
      primaryKey:
      - '#/definitions/systemProperties/properties/id'
      uniqueKey:
      - [ '#/properties/inputs/properties/dna_alignment_id' ]   # one dna_alignment can only appear once in dna_alignment_qc
      references:
      - foreignKey:
        - '#/properties/inputs/properties/dna_alignment_id'
        targetEntity: 'dna_alignment'   # dna_alignment_qc to dna_alignment is one-to-one
        targetKey:  # relationship by primaryKey
        - 'dna_alignment#/definitions/systemProperties/properties/id'

  systemProperties:
    properties:
      status:
        $ref: _definitions#/common/properties/bundle_status
      id:
        $ref: _definitions#/common/properties/uuid
      donor:
        $ref: dna_alignment#/definitions/systemProperties/properties/donor
      library_strategy:
        $ref: dna_alignment#/definitions/systemProperties/properties/library_strategy
      schema_version:
        $ref: '_definitions#/_/properties/version'
        default: '#/definitions/version/const'  # where to pick up the version

required:
- type
- program
- inputs
- analysis
- qc_metrics
- files

properties:
  type:
    const: "dna_alignment_qc"
  program:
    $ref: _definitions#/common/properties/program_short_name
  inputs:
    additionalProperties: false
    required: [ dna_alignment_id, files ]
    properties:
      dna_alignment_id:
        $ref: dna_alignment#/definitions/systemProperties/properties/id
      files:
        properties:
          aligned_dna_seq:   # input file is aligned bam/cram (multi-lane)
            properties:
              object_uri:  # if file is local, object_id will be 'null'
                type: string  # pattern: song://<repository>/<bundle_id>/<object_id>
              bundle_id:  # dna_alignment
                $ref: "#/properties/inputs/properties/dna_alignment_id"  # get value from
              object_id:  # aligned sequencing file object ID in the above dna_alignment
                type: string
              name:  # file name
                pattern: '\.(bam|cram)$'  # find the bam or cram in the bundle as input file
              secondary_file:  # secondary file(s), following CWL standard
                enum: [ '.bai', '.crai' ]
              repository:  # repo where the object resides
                type: string
  analysis:
    type: object
    properties:
      analysis_type:
        const: 'QC'
      core_tool:
        const: 'Picard'
      tool:  # Tool refers to what's in GA4GH's Tool Registry Service
        type: object
        properties:
          registry:
            type: string  # such as Dockstore
          tool_id:
            type: string
          tool_name:
            type: string
          version:
            type: string
      execution:
        type: object
        properties:
          runner_name:
            type: string
          runner_version:
            type: string
          job_id:
            type: string
          started_at:
            type: string
            format: date-time
          completed_at:
            type: string
            format: date-time
  qc_metrics:
    type: object  # to flesh out with more metrics to be included
    properties:
      insert_size_stats:
        type: object
        properties:
          max_insert_size:
            type: integer
          mean_insert_size:
            type: integer
          median_absolute_deviation:
            type: integer
          median_insert_size:
            type: integer
          min_insert_size:
            type: integer
          mode_insert_size:
            type: integer
          read_pairs:
            type: integer
          standard_deviation:
            type: integer
  files:
    type: object
    additionalProperties: false
    properties:
      quality_distribution:
        $ref: dna_alignment_qc.quality_distribution.data_object

      bait_bias_detail_metrics:
        $ref: dna_alignment_qc.bait_bias_detail_metrics.data_object
