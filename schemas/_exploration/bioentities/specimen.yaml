$schema: "http://json-schema.org/draft-07/schema#"

$id: "specimen"
title: Specimen
type: object

definitions:
  version:
    allOf:
    - $ref: '_definitions#/_/properties/version'
    - const: 1
  relationDef:
    $ref: '_definitions#/_/properties/relationDef'
    const:
      primaryKey:
      - '#/definitions/systemProperties/properties/id'
      naturalKey:
      - '#/properties/program_id'
      - '#/properties/submitter_specimen_id'
      references:
      - foreignKey:
        - '#/properties/program_id'
        - '#/properties/submitter_donor_id'
        targetEntity: 'donor'
        targetKey:  # relationship by naturalKey
        - 'donor#/properties/program_id'
        - 'donor#/properties/submitter_donor_id'
      - foreignKey:
        - '#/definitions/systemProperties/properties/donor_id'
        targetEntity: 'donor'
        targetKey:  # relationship by primaryKey
        - 'donor#/definitions/systemProperties/properties/id'
  systemProperties:  # properties will be populated by the system
    propertyNames:
      enum: [ id, donor_id, schema_version ]
    required: [ id, donor_id, schema_version ]
    properties:
      schema_version:
        $ref: '#/definitions/version'  # where to pick up the version
      id:  # primary key, defined in 'primaryKey'
        allOf:
        - $ref: _definitions#/common/properties/id
        - pattern: "^SP"  # id must start with "SP", in addition to pattern defined at _definitions#/common/properties/id
      donor_id:  # foreign key to donor entity, the relationship is defined in 'references'
        $ref: donor#/definitions/systemProperties/properties/id
      schema_version:
        $ref: '_definitions#/_/properties/version'
        default: '#/definitions/version/const'  # where to pick up the version

propertyNames:  # this will reject any unknown properties, note that 'additionalProperties: false' does not work with allOf
  enum: [ type, program_id, submitter_specimen_id, submitter_donor_id, tumour_normal_designation ]

required:
- type
- submitter_specimen_id
- submitter_donor_id
- program_id
- tumour_normal_designation

properties:
  type:
    const: "specimen"
  program_id:
    $ref: _definitions#/common/properties/program_id
  submitter_specimen_id:
    $ref: _definitions#/common/properties/submitter_id
    description: "Submitter's specimen ID"
  submitter_donor_id:
    $ref: _definitions#/common/properties/submitter_id
  tumour_normal_designation:
    type: string
    enum:  # https://github.com/icgc-argo/argo-dictionary/blob/bf7ccf7bcaf202d5be813084647a8376238e4503/schemas/sample_registration.json#L78-L92
    - "Normal"
    - "Normal - tissue adjacent to primary tumour"
    - "Primary tumour"
    - "Primary tumour - adjacent to normal"
    - "Primary tumour - additional new primary"
    - "Recurrent tumour"
    - "Metastatic tumour"
    - "Metastatic tumour - metastasis local to lymph node"
    - "Metastatic tumour - metastasis to distant location"
    - "Metastatic tumour - additional metastatic"
    - "Xenograft - derived from primary tumour"
    - "Xenograft - derived from tumour cell line"
    - "Cell line - derived from xenograft tumour"
    - "Cell line - derived from tumour"
    - "Cell line - derived from normal"    
